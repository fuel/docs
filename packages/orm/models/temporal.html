<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./../../../assets/css/combined.css">
	<link rel="shortcut icon" href="./../../../favicon.ico" />
	<script src="http://www.google.com/jsapi" type="text/javascript"></script>
	<script type="text/javascript">
		var path = './../../../';
                var class_prefix = 'Model_Temporal::';
	</script>
	<script src="./../../../assets/js/combined.js"></script>
	<title>Temporal Model - Orm Package - FuelPHP Documentation</title>
</head>
<body>
	<div id="container">
		<header id="header">
			<div class="table">
				<h1>
					<strong>FuelPHP, a PHP 5.3 Framework</strong>
					Documentation
				</h1>

				<form id="google_search">
					<p>
						<span id="search_clear">&nbsp;</span>
						<input type="submit" name="search_submit" id="search_submit" value="search" />
						<input type="text" value="" id="search_input" name="search_input" />
					</p>
				</form>
			</div>
			<nav>

				<div class="clear"></div>
			</nav>
			<a href="#" id="toc_handle">table of contents</a>
			<div class="clear"></div>
		</header>

		<div id="cse">
			<div id="cse_point"></div>
			<div id="cse_content"></div>
		</div>

            <div id="main">
                <section>
                    <h2 id="introduction">Introduction</h2>
                    <p>The temporal model is a lot less scary than it sounds. </p>
                    <p>Usually in a database entities are represented by a row in a table, when this row is updated the old information is overwritten. The temporal model allows data to be referenced in time, it makes it possible to query the state of an entity at a given time.</p>
                    <p>For example, say you wanted to keep track of changes to products so when an order is placed you know the state of the product without having to duplicate data in the orders table. You can make the products temporal and use the time of the order to reference the state of the ordered products at that time rather than how they currently are, as would happen without using temporal data.</p>
                    <p>The temporal model could also be used for auditing changes to things like wiki pages. Any changes would be automatically logged without having to use a separate log table.</p>
                    <p>This implementation of a temporal model stores revisions of entities in the same table as the original data, removing the need for duplicate “log” tables.</p>
                    <h1>Why do this in the ORM and not just choose a database system that allows it?</h1>
                    <p>Implementing the temporal functionality within the ORM allows the mechanics to be abstracted out of the database level, this allows the use of any database that the ORM supports with temporal models, providing greater flexibility. This model does not replace the ability to use a database that supports temporal information but provides an "out of the box" implementation.</p>
                </section>
                
                <section>
                    <h2 id="use">Use</h2>
                    <p>The table must be set up with a dual primary key of the entity ID, just a standard auto-incrementing number (for example), and a timestamp that represents the valid timespan of the row.</p>
                    <pre id="php"><code>class Model_MyTemporal extends Orm\Model_Temporal
{
	protected static $_primary_key = array('id', 'temporal');
	protected static $_temporal =  array(
		'timestamp_name' => 'temporal', //Name of the column that contains the timestamps
		'mysql_timestamp' => true, //If set to false will use unix timestamps rather than MySQL timestamps
	);
}</code></pre>
                    <p class="note">Please note that the primary key must be a dual key between the entity id and the temporal timestamp.</p>
                    <p class="note">Any relations that are defined using temporal models should relate only on the id and not both id and timestamp.</p>
                </section>
                
                <article>
                    <h4 id="method_find" class="method"><a class="interal_link" href="#/method_find">find()</a></h4>
                    <p>The find method works exactly the same as the regular model's implementation except that a where clause is added to select only the latest revision of an entity.</p>
                </article>
                
                <article>
                    <h4 id="method_find_revision" class="method"><a class="interal_link" href="#/method_find">find_revision($id, $timestamp=null, $relations = array())</a></h4>
                    <p>This method can be used to query the state of an entity at the given time.</p>
                    <table class="method">
                        <tbody>
                            <tr>
                                <th class="legend">Static</th>
                                <td>Yes</td>
                            </tr>
                            <tr>
                                <th>Parameters</th>
                                <td>
                                    <table class="parameters">
                                        <tr>
                                            <th>Param</th>
                                            <th>Default</th>
                                            <th class="description">Description</th>
                                        </tr>
                                        <tr>
                                            <th><kbd>$id</kbd></th>
                                            <td><em>required</em></td>
                                            <td>The ID of the entity to search for.</td>
                                        </tr>
                                        <tr>
                                            <th><kbd>$timestamp</kbd></th>
                                            <td><pre class="php"><span class="keyword">null</span></pre></td>
                                            <td>The time to reference the entity at. <kbd>null</kbd> will return the most current revision.</td>
                                        </tr>
                                        <tr>
                                            <th><kbd>$relations</kbd></th>
                                            <td><pre class="php"><span class="keyword">array</span></pre></td>
                                            <td>Names of the relations to load with the entity.</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <th>Returns</th>
                                <td>A single subclass of <kbd>Model_Temporal</kbd></td>
                            </tr>
                            <tr>
                                <th>Example</th>
                                <td>
                                    <pre class="php"><code>Model_Product::find_revision($id, '2012-11-09 12:04:00', array('images', 'reviews'));</code></pre>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="note"><strong>Please note</strong> that returned relations will be the most current version of those entities.</p>
                </article>
                
                <article>
                    <h4 id="method_find_revision" class="method"><a class="interal_link" href="#/method_find">find_revisions_between($id, $earliestTime = null, $latestTime = null)</a></h4>
                    <p>This method will return the states of an entity between the given times.</p>
                    <table class="method">
                        <tbody>
                            <tr>
                                <th class="legend">Static</th>
                                <td>Yes</td>
                            </tr>
                            <tr>
                                <th>Parameters</th>
                                <td>
                                    <table class="parameters">
                                        <tr>
                                            <th>Param</th>
                                            <th>Default</th>
                                            <th class="description">Description</th>
                                        </tr>
                                        <tr>
                                            <th><kbd>$id</kbd></th>
                                            <td><em>required</em></td>
                                            <td>The ID of the entity to search for.</td>
                                        </tr>
                                        <tr>
                                            <th><kbd>$earliestTime</kbd></th>
                                            <td><pre class="php"><span class="keyword">null</span></pre></td>
                                            <td>The time of the earliest revision to find or <kbd>null</kbd> for an infinite number of previous revisions.</td>
                                        </tr>
                                        <tr>
                                            <th><kbd>$latestTime</kbd></th>
                                            <td><pre class="php"><span class="keyword">null</span></pre>, <pre class="php"><span class="keyword">string</span></pre> or <pre class="php"><span class="keyword">integer</span></pre></td>
                                            <td>The time of the latest revision to find or <kbd>null</kbd> for an infinite number of revisions (up to the latest).</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <th>Returns</th>
                                <td>An array of subclasses of <kbd>Model_Temporal</kbd></td>
                            </tr>
                            <tr>
                                <th>Example</th>
                                <td>
                                    <pre class="php"><code>Model_Product::find_revisions_between($id, '2012-11-09 12:04:00', '2012-12-09 12:04:00');</code></pre>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="note">It is currently not possible to select relations at the same time.</p>
                </article>
                
                <section>
                    <h2 id="known_problems">Known Problems</h2>
                    <h1>Relations</h1>
                    <p>Relations are handled in a very much less than awesome way. At this point in time there's no way to properly fetch related entities for a given time within one query. If related entries need to be selected at a point in time (rather than most recent) then extra calls to <kbd>find_revision()</kbd> or <kbd>find_revisions_between()</kbd> are needed.</p>
                </section>
            </div>

		<footer>
			<p>
				&copy; FuelPHP Development Team 2010-2012 - <a href="http://fuelphp.com">FuelPHP</a> is released under the MIT license.
			</p>
		</footer>
	</div>
</body>
</html>
